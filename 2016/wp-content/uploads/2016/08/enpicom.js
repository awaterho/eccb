"use strict";function countryBars(dispatch,data,container,width,height){function visibleCountries(limit,offset){return function(d,i){return i>=offset&&i<offset+limit}}function otherCountries(limit,offset){var filter=visibleCountries(limit,offset);return function(d,i){return!filter(d,i)}}function displayCountriesSelection(countries,limit,offset){for(var countriesSubset=countries.filter(visibleCountries(limit,offset)),placeholder=[],i=countriesSubset.length;i<limit;i++)placeholder.push("Placeholder "+i);var paddedDomain=[].concat.apply([],[countriesSubset.map(function(d){return d.key}),placeholder,["Others"]]);countriesSubset.push({id:"Others("+[limit,offset]+")",key:"Others",values:{countries:countries.filter(otherCountries(limit,offset))}}),countriesSubset[countriesSubset.length-1].values.numAuthors=d3.sum(countriesSubset[countriesSubset.length-1].values.countries,function(d){return d.values.numAuthors}),yScaleCountry.domain(paddedDomain),xScaleCountry.domain([0,d3.max(countriesSubset,function(d){return d.values.numAuthors})]),colorScaleCountry.domain(paddedDomain),container.selectAll(".country").data(countriesSubset,function(d){return d.id||d.key}).call(drawBars)}function drawBars(selection){function isTextTooLong(element,d){return element.getBBox().width+10>xScaleCountry(d.values.numAuthors)}var ease=d3.ease("exp"),countryExit=selection.exit();countryExit.transition().duration(550).ease(ease).delay(function(d,i){return 50*i}).attr("transform","translate("+[0,yScaleCountry("Others")]+")").remove();var countryEnter=selection.enter().append("g").attr("class","country").attr("transform","translate("+[0,yScaleCountry("Others")]+")").on("mouseenter",function(d){var that=d3.select(this);that.selectAll("line").transition("highlight").duration(100).delay(200).ease("exp-in").attr("x2",function(d){var textNode=that.select("text").node(),extra=0;return isTextTooLong(textNode,d)&&(extra=textNode.getBBox().width+5),xScaleCountry(d.values.numAuthors)+extra}),d3.selectAll(".institute").filter(function(e){var country="undefined"==typeof yScaleCountry(e.country)?"Others":e.country;return d.key!==country}).transition().duration(150).style("fill","#999999").style("opacity",.1)}).on("mouseleave",function(d){d3.select(this).selectAll("line").transition("highlight").duration(150).attr("x2",0),d3.selectAll(".institute").filter(function(e){var country="undefined"==typeof yScaleCountry(e.country)?"Others":e.country;return d.key!==country}).transition().duration(700).delay(function(){return 600*Math.random()}).style("fill",function(e){return colorScaleCountry("undefined"==typeof yScaleCountry(e.country)?"Others":e.country)}).style("opacity",1)});countryEnter.transition().duration(550).ease(ease).delay(function(d,i){return 50*i}).attr("transform",function(d){return"translate("+[0,yScaleCountry(d.key)]+")"}),countryEnter.filter(function(d){return"Others"===d.key}).on("click",function(){offset+=limit,offset>=countries.length&&(offset=0),displayCountriesSelection(countries,limit,offset)}),countryEnter.filter(function(d){return"Others"!==d.key}).on("click",function(d){dispatch.countryClick(d)}),countryEnter.append("rect").attr("class","shadow").attr("width",function(d){return xScaleCountry(d.values.numAuthors)}).attr("height",yScaleCountry.rangeBand()),countryEnter.append("rect").attr("class","color").attr("width",function(d){var institutes=d3.selectAll(".institute").filter(function(e){var country="undefined"==typeof yScaleCountry(e.country)?"Others":e.country;return country===d.key}).data();return d.values.currentNumAuthors=d.values.numAuthors-d3.sum(institutes,function(e){return e.numAuthors}),xScaleCountry(d.values.currentNumAuthors)}).attr("height",yScaleCountry.rangeBand()).style("fill",function(d){return colorScaleCountry(d.key)}),countryEnter.append("text").attr("class","name").attr("y",function(){return yScaleCountry.rangeBand()/2}).text(function(d){return d.key}).classed("long",function(d){return isTextTooLong(this,d)}).attr("x",function(d){return isTextTooLong(this,d)?xScaleCountry(d.values.numAuthors)+5:5}).attr("y",function(){return yScaleCountry.rangeBand()/2}).call(fixIE),countryEnter.append("line").attr({y1:function(d){return yScaleCountry.rangeBand()+2},y2:function(d){return yScaleCountry.rangeBand()+2},x1:0,x2:0}),countryEnter.append("rect").attr({"class":"transparent",height:yScaleCountry.rangeBand(),width:function(d){var textNode=countryEnter.selectAll("text").filter(function(e){return e.key===d.key}).node(),extra=0;return isTextTooLong(textNode,d)&&(extra=textNode.getBBox().width+5),xScaleCountry(d.values.numAuthors)+extra}})}var limit=13,offset=0,countries=d3.nest().key(function(d){return d.country}).rollup(function(leaves){return{isoA3:leaves[0].isoA3,numAuthors:d3.sum(leaves,function(d){return d.numAuthors})}}).entries(data);countries.sort(function(a,b){return b.values.numAuthors-a.values.numAuthors});var yScaleCountry=d3.scale.ordinal().rangeRoundBands([0,height],.2,0),xScaleCountry=d3.scale.linear().rangeRound([0,width]),colorScaleCountry=d3.scale.ordinal().range(Array.apply(null,Array(limit)).map(function(){return"#0035A8"}).concat(["#999999"]));return dispatch.on("instituteEnter",function(d){d3.selectAll(".country .color").filter(function(e){var country="undefined"==typeof yScaleCountry(d.country)?"Others":d.country;return e.key===country}).transition("resize").duration(700).attr("width",function(e){return e.values.currentNumAuthors=e.values.currentNumAuthors-d.numAuthors,xScaleCountry(e.values.currentNumAuthors)})}),dispatch.on("instituteExit",function(d){d3.selectAll(".country .color").filter(function(e){var country="undefined"==typeof yScaleCountry(d.country)?"Others":d.country;return e.key===country}).transition("resize").duration(700).attr("width",function(e){return e.values.currentNumAuthors=e.values.currentNumAuthors+d.numAuthors,xScaleCountry(e.values.currentNumAuthors)})}),displayCountriesSelection(countries,limit,offset),{x:xScaleCountry,y:yScaleCountry,color:colorScaleCountry}}function cityDetails(dispatch,locationsData,container,width,height){}function globeMap(dispatch,topo,data,width,height,map,globe){function color(count){return 0===count?baseColor:color_scale(count)}function getCount(iso_a3){var matching=data.filter(function(d){return d.key===iso_a3});return 1==matching.length?matching[0].values:0}function zoomed(){var zoomTr=zoom.translate(),zoomSc=zoom.scale();zoomProjection.scale(zoom.scale()).translate(zoomTr);var topLeftLngLat=zoomProjection.invert([0,0]),bottomRightLngLat=zoomProjection.invert([width,height]);if(topLeftLngLat[0]<minLng||bottomRightLngLat[0]>maxLng)if(zoomSc!=projection.scale()){var lng;bottomRightLngLat[0]>maxLng?(lng=[bottomRightLngLat[0],bottomRightLngLat[1]],lng[0]=bottomRightLngLat[0]>180?360-bottomRightLngLat[0]:bottomRightLngLat[0],zoomTr[0]-=zoomProjection(lng)[0]-zoomProjection([maxLng,maxLat])[0]):(lng=[topLeftLngLat[0],topLeftLngLat[1]],lng[0]=topLeftLngLat[0]<-180?-topLeftLngLat[0]-360:topLeftLngLat[0],zoomTr[0]-=zoomProjection(lng)[0]-zoomProjection([minLng,minLat])[0])}else zoomTr[0]=projection.translate()[0]-.01;(topLeftLngLat[1]>maxLat||bottomRightLngLat[1]<minLat)&&(zoomSc!=projection.scale()?topLeftLngLat[1]>maxLat?zoomTr[1]+=zoomProjection(topLeftLngLat)[1]-zoomProjection([maxLng,maxLat])[1]:zoomTr[1]+=zoomProjection(bottomRightLngLat)[1]-zoomProjection([minLng,minLat])[1]:zoomTr[1]=projection.translate()[1]-.01),zoomProjection.scale(zoom.scale()).translate(zoomTr),projection.scale(zoom.scale()).translate(zoomTr),zoom.translate(zoomTr),updateMap(projection)}function projectionTween(a,b){var α,projection=d3.geo.mercator().clipExtent(a.clipExtent());return projection.alpha=function(_){if(!arguments.length)return α;α=+_;var sa=a.scale(),sb=b.scale(),ca=a.center(),cb=b.center(),ta=a.translate(),tb=b.translate();return projection.scale((1-α)*sa+α*sb),projection.center([(1-α)*ca[0]+α*cb[0],(1-α)*ca[1]+α*cb[1]]),projection.translate([(1-α)*ta[0]+α*tb[0],(1-α)*ta[1]+α*tb[1]]),projection},projection.alpha(0)}function updateMap(projection){path.projection(projection);var newCenter=projection.invert([width/2,height/2]);projectionGlobe.rotate([-newCenter[0],-newCenter[1]]),map.selectAll("path").attr("d",path),svgGlobe.selectAll("path.land").attr("d",pathGlobe),dispatch.mapUpdate(projection),svgGlobe.selectAll(".graticule").attr("d",pathGlobe),map.selectAll("path.land").filter(function(d){return null!==d3.select(this).attr("d")}),map.selectAll("circle").attr({cx:function(d){return d.x},cy:function(d){return d.y}}),svgGlobe.selectAll("circle").transition().attr({cx:function(d){var latlon=projection.invert([d.x,d.y]);return projectionGlobe(latlon)[0]},cy:function(d){var latlon=projection.invert([d.x,d.y]);return projectionGlobe(latlon)[1]}})}var globeWidth=200,globeHeight=200,center=[4.3007,52.0705],scale0=(width-1)/2/Math.PI*6,scale1=(globeWidth-1)/2/Math.PI*3,zoom=d3.behavior.zoom().translate([width/2,height/2]).scale(.5*scale0).scaleExtent([.3*scale0,3*scale0]),maxLat=73,minLat=-55,maxLng=179,minLng=-175,projection=d3.geo.mercator().center(center).clipExtent([[0,0],[width,height]]),boundsProjection=d3.geo.mercator().scale(1).translate([0,0]).center(center),zoomProjection=d3.geo.mercator().center(center).clipExtent([[0,0],[width,height]]),projectionGlobe=d3.geo.orthographic().center(center).translate([.6*globeWidth,.12*globeHeight]).scale(scale1).clipAngle(90),path=d3.geo.path().projection(projection),pathGlobe=d3.geo.path().projection(projectionGlobe),globeSphere={type:"Sphere"},svgGlobe=globe.attr("width",globeWidth+10).attr("height",globeHeight+5);map.call(zoom).call(zoom.event),svgGlobe.call(zoom).call(zoom.event);var world=(svgGlobe.append("defs"),topo);zoom.on("zoom",zoomed);var color_scale=d3.scale.linear().domain([d3.min(data,function(d){return d.values}),d3.max(data,function(d){return d.values})]).range(["#FAE3D4","#FC6300"]),baseColor="#EEEEEE",blankMap=map.selectAll("path").data(topojson.feature(world,world.objects.countries).features).enter().append("path").classed("land",!0).attr("d",path);blankMap.transition().duration(3e3).styleTween("fill",function(d){return d3.interpolate(baseColor,color(getCount(d.properties.iso_a3)))}),svgGlobe.append("path").datum(function(){return pathGlobe(globeSphere)}).attr("class","foreground").attr("d",pathGlobe(globeSphere)),svgGlobe.selectAll("path").data(topojson.feature(world,world.objects.countries).features).enter().append("path").classed("land",!0).attr("d",path).transition().duration(1500).ease("exp-out").styleTween("fill",function(d){return d3.interpolate(baseColor,color(getCount(d.properties.iso_a3)))}),dispatch.mapColor(color_scale,baseColor);var graticule=d3.geo.graticule();svgGlobe.append("path").datum(graticule).attr("class","graticule").attr("d",pathGlobe);var points=generateRect({hor:100,ver:50},25,25,width,height);svgGlobe.selectAll("circle").data(points).enter().append("circle").attr("r",1.25),dispatch.on("countryClick",function(d){var country=topojson.feature(world,world.objects.countries).features.filter(function(e){return e.properties.iso_a3===d.values.isoA3}),originalProjection=d3.geo.mercator().center(center).clipExtent([[0,0],[width,height]]);originalProjection.scale(projection.scale()).translate(projection.translate());var b;b="RUS"===country[0].id?[[29.04,41.05],[147.886099,68.736223]]:d3.geo.bounds(country[0]);var left=boundsProjection(b[0])[0],top=boundsProjection(b[0])[1],right=boundsProjection(b[1])[0],bottom=boundsProjection(b[1])[1],s=Math.min(zoom.scaleExtent()[1],.95/Math.max((right-left)/width,(top-bottom)/height)),t=[(width-s*(left+right))/2,(height-s*(top+bottom))/2];projection.scale(s).translate(t);var topLeftLngLat=projection.invert([0,0]),bottomRightLngLat=projection.invert([width,height]);if(topLeftLngLat[0]<minLng||bottomRightLngLat[0]>maxLng){var lng;bottomRightLngLat[0]>maxLng?(lng=[bottomRightLngLat[0],bottomRightLngLat[1]],lng[0]=bottomRightLngLat[0]>180?360-bottomRightLngLat[0]:bottomRightLngLat[0],t[0]-=projection(lng)[0]-projection([maxLng,maxLat])[0]):(lng=[topLeftLngLat[0],topLeftLngLat[1]],lng[0]=topLeftLngLat[0]<-180?-topLeftLngLat[0]-360:topLeftLngLat[0],t[0]-=projection(lng)[0]-projection([minLng,minLat])[0])}(topLeftLngLat[1]>maxLat||bottomRightLngLat[1]<minLat)&&(topLeftLngLat[1]>maxLat?t[1]+=projection(topLeftLngLat)[1]-projection([maxLng,maxLat])[1]:t[1]+=projection(bottomRightLngLat)[1]-projection([minLng,minLat])[1]),projection.translate(t),map.transition().duration(1500).tween("projection",function(){var interpolator=projectionTween(originalProjection,projection);return function(i){interpolator.alpha(i),updateMap(interpolator)}}),zoom.scale(projection.scale()).translate(projection.translate())}),zoomed()}function generateRect(numPoints,x,y,width,height){var points=[],sideNumHor=Math.floor(numPoints.hor/4)+1,sideNumVer=Math.floor(numPoints.ver/4)+1;return d3.range(sideNumHor).forEach(function(i){points.push({x:x+i*width/sideNumHor,y:y})}),d3.range(sideNumVer).forEach(function(i){points.push({x:x+width,y:y+i*height/sideNumVer})}),d3.range(sideNumHor).forEach(function(i){points.push({x:x+width-i*width/sideNumHor,y:y+height})}),d3.range(sideNumVer).forEach(function(i){points.push({x:x,y:y+height-i*height/sideNumVer})}),points}function initialize(error,topoData,locationsData,submissionsData){if(error)throw error;var submissions=submissionsData.map(function(s){return{key:s.isoA3,values:s.numSubmissions}}),countries=countryBars(dispatch,locationsData,barchart,barchartWidth,barchartHeight);cityLegend(dispatch,svgCityLegend,legendWidth,legendHeight,separator),submissionLegend(dispatch,svgSubmissionLegend,legendWidth,legendHeight,separator),institutePoints(dispatch,locationsData,countries,circleGroup,cityOveralyGroup,mapWidth,mapHeight,separator),globeMap(dispatch,topoData,submissions,mapWidth,mapHeight,map,svgGlobe),cityDetails(dispatch,locationsData,detailsGroup,detailsWidth,detailsHeight)}function fixIE(sel){(isIE||isEdge)&&sel.attr("dy","0.55ex")}function institutePoints(dispatch,data,countries,container,labelContainer,width,height,separator){labelContainer.append("text").attr("class","shadow"),labelContainer.append("text"),dispatch.on("mapUpdate",function(projection){function isInsideViewport(d){var position=projection([d.lng,d.lat]);return d.mapX=position[0],d.mapY=position[1],d.mapX<=width&&d.mapX>=0&&d.mapY>=0&&d.mapY<=height}var sizeScaleInstitute=d3.scale.pow().exponent(.5).domain(d3.extent(data,function(d){return d.numAuthors})).range([2,projection.scale()/60]);dispatch.cityScale(sizeScaleInstitute);var institutes=container.selectAll(".institute:not(.exiting)").data(data.filter(isInsideViewport),function(d){return d.id});institutes.filter(function(d){return!d3.select(this).classed("entering")}).attr("cx",function(d){return d.mapX}).attr("cy",function(d){return d.mapY}).attr("r",function(d){return sizeScaleInstitute(d.numAuthors)}),institutes.enter().append("circle").attr("class","institute entering").attr("r",function(d){return Math.min(countries.y.rangeBand()/2,sizeScaleInstitute(d.numAuthors))}).attr("cx",function(d){return width+separator+5}).attr("cy",function(d){var countryY="undefined"==typeof countries.y(d.country)?countries.y("Others"):countries.y(d.country);return countryY+countries.y.rangeBand()/2}).style("fill",function(d){return"undefined"==typeof countries.y(d.country)?countries.color("Others"):countries.color(d.country)}).on("mouseleave",function(d){labelContainer.selectAll("text").transition().style("opacity",0)}).on("click",function(d){dispatch.countryClick({key:d.country,values:{isoA3:d.isoA3}})}).transition("entering").duration(900).ease("poly-in",5).delay(function(d,i){return 400*Math.random()}).tween("attr.r",function(d){var i=d3.interpolateRound(Math.min(countries.y.rangeBand()/2,sizeScaleInstitute(d.numAuthors)),sizeScaleInstitute(d.numAuthors));return function(t){this.setAttribute("r",i(t))}}).tween("attr.cx",function(d){var i,x=null;return function(t){x!==d.mapX&&(x=d.mapX,i=d3.interpolateRound(width+separator+5,x)),this.setAttribute("cx",i(t))}}).tween("attr.cy",function(d){var i,y=null,countryY="undefined"==typeof countries.y(d.country)?countries.y("Others"):countries.y(d.country);return function(t){y!==d.mapY&&(y=d.mapY,i=d3.interpolateRound(countryY+countries.y.rangeBand()/2,y)),this.setAttribute("cy",i(t))}}).each("end",function(){d3.select(this).classed("entering",!1)}).each("start",function(d){dispatch.instituteEnter(d)}),institutes.on("mouseenter",function(d){var coords=projection([d.lng,d.lat]);labelContainer.selectAll("text").text(function(){return d.city}).attr("x",function(){return Math.max(Math.round(coords[0]),this.getBBox().width/2)}).attr("y",function(){return Math.max(Math.round(coords[1]),this.getBBox().height)}).transition().style("opacity",1)}),institutes.exit().classed("exiting",!0).transition("exiting").duration(900).ease("poly-out",5).delay(function(d,i){return 400*Math.random()}).attr("cx",function(d){return width+separator+5}).attr("cy",function(d){var countryY="undefined"==typeof countries.y(d.country)?countries.y("Others"):countries.y(d.country);return countryY+countries.y.rangeBand()/2}).attr("r",function(d){return Math.min(countries.y.rangeBand()/2,sizeScaleInstitute(d.numAuthors))}).each("start",function(d){dispatch.instituteExit(d)}).remove()})}function cityLegend(dispatch,container,width,height,separator){var legendPoints=[0,.25,.5,1],dotSize=container.selectAll("g.tick").data(legendPoints),dotSizeEnter=dotSize.enter().append("g").attr("class","tick");dotSizeEnter.append("circle").attr("cy",height/2),dotSizeEnter.append("text").attr("y",height/2);var textLabelNode=container.append("text").text("Authors per location:").attr("y",height/2).call(fixIE).node(),startingAt=textLabelNode.getBBox().width+20;dispatch.on("cityScale",function(scale){var range=scale.range(),interpolator=d3.interpolateNumber(range[0],range[1]);container.selectAll("g").attr("transform",function(d,i){var spacing=d3.sum(legendPoints.filter(function(_,n){return n<=i}).map(function(e,n){return n?2*interpolator(e)+2*separator+30:0}));return"translate("+[startingAt+separator+spacing,0]+")"}),container.selectAll("g.tick circle").attr("r",function(d){return interpolator(d)}),container.selectAll("g.tick text").attr("x",function(d,i){return interpolator(d)+separator}).text(function(d){return Math.round(scale.invert(interpolator(d)))}).call(fixIE)})}function submissionLegend(dispatch,container,width,height,separator){var legendPoints=[0,.25,.5,1],rectSize=25,colorRect=container.selectAll("g.tick").data(legendPoints),textLabelNode=container.append("text").text("Submissions per country:").attr("y",height/2).call(fixIE).node(),startingAt=textLabelNode.getBBox().width+20,colorRectEnter=colorRect.enter().append("g").attr("class","tick").attr("transform",function(d,i){return"translate("+[startingAt+separator+i*(rectSize+30+2*separator),height/2-rectSize/2]+")"});colorRectEnter.append("rect").attr({height:rectSize,width:rectSize,y:0,x:0}).style("fill","white"),colorRectEnter.append("text").attr({y:height/4,x:rectSize+separator}).text(function(d){return d}).call(fixIE),dispatch.on("mapColor",function(scale,base){var domain=scale.domain(),interpolator=d3.interpolateNumber(domain[0],domain[1]);container.selectAll("g.tick rect").transition().style("fill",function(d,i){return 0===i?base:scale(interpolator(d))}),container.selectAll("g.tick text").text(function(d,i){return 0===i?0:Math.round(interpolator(d))}).call(fixIE)})}var isIE=!!document.documentMode,isEdge=!isIE&&!!window.StyleMedia,isChrome=!!window.chrome&&!!window.chrome.webstore;if(!isChrome){var ieWarning=d3.select("#ie-warning");ieWarning.size()>0&&ieWarning.style("display",null)}var dispatch=d3.dispatch("mapUpdate","mapColor","countryClick","instituteEnter","instituteExit","cityScale"),width=document.getElementById("canvas").offsetWidth,height=Math.max(400,document.getElementById("canvas").offsetHeight),separator=5,margin={top:5,bottom:5,left:5,right:5},drawingWidth=width-margin.left-margin.right-separator,drawingHeight=height-margin.top-margin.bottom-separator,mapWidth=Math.floor(.7*drawingWidth),mapHeight=Math.floor(1*drawingHeight),detailsWidth=drawingWidth+separator,detailsHeight=drawingHeight-mapHeight,barchartWidth=drawingWidth-mapWidth,barchartHeight=mapHeight,legendWidth=width,legendHeight=50;width<568?d3.select("div#canvas").append("p").style("color","coral").text("Please try to use your mobile device in landscape mode and reload the page, or connect from your laptop/desktop computer."):queue().defer(d3.json,"/wp-content/uploads/2016/08/world-110m.json").defer(d3.json,"/wp-content/uploads/2016/08/locations.json").defer(d3.json,"/wp-content/uploads/2016/08/submissions.json").await(initialize);var div=d3.select("div#canvas").style("position","relative"),svgMain=div.append("svg").attr("width",width).attr("height",height),svgGlobe=div.append("svg").attr("class","remove-me").style("position","absolute").style("bottom",detailsHeight+separator+"px").style("left",0),svgCityLegend=d3.select("div.city.legend").append("svg").attr("width",legendWidth).attr("height",legendHeight),svgSubmissionLegend=d3.select("div.submission.legend").append("svg").attr("width",legendWidth).attr("height",legendHeight),map=svgMain.append("g").attr("class","map").attr("transform","translate("+[margin.left,margin.top]+")");map.append("rect").attr("class","water").attr("width",mapWidth).attr("height",mapHeight);var barchart=svgMain.append("g").attr("class","barchart").attr("transform","translate("+[margin.left+mapWidth+separator,margin.top]+")"),detailsGroup=svgMain.append("g").attr("class","details").attr("transform","translate("+[margin.left,margin.top+mapHeight+separator]+")"),circleGroup=svgMain.append("g").attr("class","circleGroup").attr("transform","translate("+[margin.left,margin.top]+")"),cityOveralyGroup=svgMain.append("g").attr("class","city overlay");
